name: CI/CD to IBM Code Engine with Docker

on:
  push:
    branches: [main]

env:
  REGION: us-south
  RESOURCE_GROUP: "Agentrix"
  PROJECT_ID: ci-cd-test
  NAMESPACE: ci-cd-test
  BACKEND_IMAGE: us.icr.io/ci-cd-test/backend
  FRONTEND_IMAGE: us.icr.io/ci-cd-test/frontend
  REGISTRY_SECRET_NAME: ci-cd-test

jobs:
  deploy-to-ibm-ce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install JQ and IBM Cloud CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud plugin install code-engine container-registry

      - name: IBM Cloud Login and Select Project
        run: |
          ibmcloud login --apikey ${{ secrets.IBMCLOUD_API_KEY }} -r ${{ env.REGION }} -g "${{ env.RESOURCE_GROUP }}"
          ibmcloud cr login
          ibmcloud ce project select --name ${{ env.PROJECT_ID }}

      - name: Determine Backend Version Tag
        id: backend-tag
        run: |
          latest_tag=$(ibmcloud cr images ${{ env.BACKEND_IMAGE }} --format json | jq -r '.[].Tag' | grep -E '^v[0-9]+$' | sort -V | tail -n 1)
          if [ -z "$latest_tag" ]; then
            next_tag="v1"
          else
            version_number=$(echo $latest_tag | tr -d 'v')
            next_tag="v$((version_number + 1))"
          fi
          echo "NEXT_BACKEND_TAG=$next_tag" >> $GITHUB_ENV
          echo "ðŸš€ Backend image version to push: ${{ env.BACKEND_IMAGE }}:$next_tag"

      - name: Build and Push Backend Image with Docker
        run: |
          docker build -t ${{ env.BACKEND_IMAGE }}:$NEXT_BACKEND_TAG ./backend
          echo "âœ… Pushing image: ${{ env.BACKEND_IMAGE }}:$NEXT_BACKEND_TAG"
          docker push ${{ env.BACKEND_IMAGE }}:$NEXT_BACKEND_TAG

      - name: Deploy Backend (Create or Update)
        run: |
          if ibmcloud ce app get --name ci-cd-backend > /dev/null 2>&1; then
            echo "ðŸ›  Updating existing backend app..."
            ibmcloud ce app update --name ci-cd-backend \
              --image ${{ env.BACKEND_IMAGE }}:$NEXT_BACKEND_TAG \
              --registry-secret ${{ env.REGISTRY_SECRET_NAME }} \
              --cpu 1 --memory 2G --es 2G --min-scale 1 \
              --port 5000 --wait-timeout 600
          else
            echo "ðŸš€ Creating new backend app..."
            ibmcloud ce app create --name ci-cd-backend \
              --image ${{ env.BACKEND_IMAGE }}:$NEXT_BACKEND_TAG \
              --registry-secret ${{ env.REGISTRY_SECRET_NAME }} \
              --cpu 1 --memory 2G --es 2G --min-scale 1 \
              --port 5000 --wait-timeout 600
          fi

      - name: Extract Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(ibmcloud ce application get --name ci-cd-backend --output json | jq -r '.url')
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
          echo "ðŸŒ Backend available at: $BACKEND_URL"

      - name: Determine Frontend Version Tag
        id: frontend-tag
        run: |
          latest_tag=$(ibmcloud cr images ${{ env.FRONTEND_IMAGE }} --format json | jq -r '.[].Tag' | grep -E '^v[0-9]+$' | sort -V | tail -n 1)
          if [ -z "$latest_tag" ]; then
            next_tag="v1"
          else
            version_number=$(echo $latest_tag | tr -d 'v')
            next_tag="v$((version_number + 1))"
          fi
          echo "NEXT_FRONTEND_TAG=$next_tag" >> $GITHUB_ENV
          echo "ðŸš€ Frontend image version to push: ${{ env.FRONTEND_IMAGE }}:$next_tag"

      - name: Build and Push Frontend Image with Docker
        run: |
          docker build -t ${{ env.FRONTEND_IMAGE }}:$NEXT_FRONTEND_TAG \
            --build-arg REACT_APP_BACKEND_URL=$BACKEND_URL \
            ./frontend
          echo "âœ… Pushing image: ${{ env.FRONTEND_IMAGE }}:$NEXT_FRONTEND_TAG"
          docker push ${{ env.FRONTEND_IMAGE }}:$NEXT_FRONTEND_TAG

      - name: Deploy Frontend (Create or Update)
        run: |
          if ibmcloud ce app get --name ci-cd-frontend > /dev/null 2>&1; then
            echo "ðŸ›  Updating existing frontend app..."
            ibmcloud ce app update --name ci-cd-frontend \
              --image ${{ env.FRONTEND_IMAGE }}:$NEXT_FRONTEND_TAG \
              --registry-secret ${{ env.REGISTRY_SECRET_NAME }} \
              --cpu 1 --memory 2G --es 2G --min-scale 1 \
              --env "REACT_APP_BACKEND_URL=$BACKEND_URL" \
              --port 8080 --wait-timeout 600
          else
            echo "ðŸš€ Creating new frontend app..."
            ibmcloud ce app create --name ci-cd-frontend \
              --image ${{ env.FRONTEND_IMAGE }}:$NEXT_FRONTEND_TAG \
              --registry-secret ${{ env.REGISTRY_SECRET_NAME }} \
              --cpu 1 --memory 2G --es 2G --min-scale 1 \
              --env "REACT_APP_BACKEND_URL=$BACKEND_URL" \
              --port 8080 --wait-timeout 600
          fi

      - name: Output Frontend URL
        run: |
          FRONTEND_URL=$(ibmcloud ce application get --name ci-cd-frontend --output json | jq -r '.url')
          echo "âœ… Frontend deployed at: $FRONTEND_URL"
